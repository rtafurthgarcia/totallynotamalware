package ch.hftm.resources;

import ch.hftm.controls.ZombieService;
import ch.hftm.controls.dto.ZombieMapper;
import ch.hftm.controls.dto.ZombieDto.GetZombieDto;
import ch.hftm.controls.dto.ZombieDto.NewZombieDto;
import ch.hftm.controls.dto.ZombieDto.UpdateZombieDto;
import ch.hftm.entities.Zombie;
import jakarta.validation.Valid;
import jakarta.annotation.security.RolesAllowed;
import jakarta.transaction.Transactional;
import jakarta.ws.rs.Consumes;
import jakarta.ws.rs.DELETE;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.POST;
import jakarta.ws.rs.PUT;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.PathParam;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;
import jakarta.ws.rs.core.SecurityContext;
import jakarta.ws.rs.core.UriInfo;

import org.bson.types.ObjectId;

@Path("/api/v1/Zombies")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class ZombieResource {

    private final ZombieService zombieService;
    private final ZombieMapper zombieMapper;

    public ZombieResource(ZombieService zombieService, ZombieMapper zombieMapper) {
        this.zombieService = zombieService;
        this.zombieMapper = zombieMapper;
    }

    @GET
    @RolesAllowed("admin")
    public Response getAllZombies() {
        return Response
        .ok()
        .entity(
            this.zombieService
                .getAllZombies()
                .stream()
                .map(zombieMapper::toGetZombieDto)
                .toList())
                .build();
    }

    @GET
    @RolesAllowed("admin")
    @Path("/{id}")
    public Response getZombieById(@PathParam("id") String id) {
        Zombie zombie = zombieService.getById(new ObjectId(id));
        if (zombie != null) {
            GetZombieDto zombieDto = zombieMapper.toGetZombieDto(zombie);
            return Response.ok(zombieDto).build();
        } else {
            return Response.status(Response.Status.NOT_FOUND).build();
        }
    }

    @POST
    @Transactional
    public Response addZombie(@Valid NewZombieDto newZombieDto, @Context UriInfo uriInfo, @Context SecurityContext securityContext) {
        Zombie Zombie = zombieMapper.fromNewZombieDto(newZombieDto);
        zombieService.setZombie(Zombie);
        var uri = uriInfo.getAbsolutePathBuilder().path(Zombie.id.toString()).build(); 
        return Response.created(uri).build();
    }

    @PUT
    @Path("/{id}")
    @Transactional
    public Response updateZombie(@PathParam("id") String id, @Valid UpdateZombieDto updateZombieDto, @Context SecurityContext securityContext) {
        ObjectId objectId = new ObjectId(id);
        Zombie existingZombie = zombieService.getById(objectId);

        if (existingZombie != null) {
            Zombie updatedZombie = zombieMapper.fromUpdateZombieDto(existingZombie, updateZombieDto);
            zombieService.setZombie(updatedZombie);
            return Response.ok().build();
        } else {
            return Response.status(Response.Status.NOT_FOUND).build();
        }
    }

    @DELETE
    @RolesAllowed("admin")
    @Path("/{id}")
    @Transactional
    public Response deleteZombie(@PathParam("id") String id) {
        ObjectId objectId = new ObjectId(id);
        Zombie existingZombie = zombieService.getById(objectId);

        if (existingZombie != null) {
            zombieService.deleteZombie(existingZombie);
            return Response.noContent().build();
        } else {
            return Response.status(Response.Status.NOT_FOUND).build();
        }
    }
}
